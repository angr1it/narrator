# üìò –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `SlotFiller` (StoryGraph)

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

`SlotFiller` ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å–ª–æ—Ç–æ–≤ –∏–∑ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞ `CypherTemplate`. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–ª—é—á–µ–≤—É—é —á–∞—Å—Ç—å –ø–∞–π–ø–ª–∞–π–Ω–∞ `/v1/extract-save`.

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
- –ü—Ä—è–º—É—é LLM-—ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—é (`extract`)
- –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ (`fallback`)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–æ–ª–µ–π (`generate`)
- –í–æ–∑–≤—Ä–∞—Ç **–æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –Ω–∞–±–æ—Ä–æ–≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π (multi-match)

---

## üß† –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

### –ü–æ–∑–∏—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ:

```mermaid
sequenceDiagram
    participant API
    participant Pipeline
    participant TemplateService
    participant SlotFiller
    participant GraphProxy

    API->>Pipeline: extract-save(text, chapter, tags)
    Pipeline->>TemplateService: find_templates(text)
    loop For each template
        Pipeline->>SlotFiller: await fill_slots(template, text)
        SlotFiller-->>Pipeline: List[slots]
        loop For each slots
            Pipeline->>GraphProxy: render + run Cypher
            GraphProxy-->>Pipeline: result
        end
    end
    Pipeline-->>API: facts, inserted_ids
```

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `LangChain + OpenAI` (Structured Output)
- `Langfuse` ‚Äî –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- `pydantic` ‚Äî –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `slot_schema`
- `CypherTemplate` ‚Äî —Å—Ö–µ–º–∞ —à–∞–±–ª–æ–Ω–∞ –∏–∑ Weaviate

---

## üßæ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```python
async def fill_slots(
    self, template: CypherTemplate, text: str
) -> List[Dict[str, Any]]:
    ...
```

–î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞
``call_llm_with_json_list_sync``.

### –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
- `template` ‚Äî —ç–∫–∑–µ–º–ø–ª—è—Ä `CypherTemplate` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º `slots`
- `text` ‚Äî —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ (2‚Äì8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)

### –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤, –∑–∞–ø–æ–ª–Ω—è–µ–º—ã—Ö –≤ —à–∞–±–ª–æ–Ω.

---

## üß© –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LangChain Structured Output Parser
- –ü—Ä–∏–≤—è–∑–∫–∞ —Å—Ö–µ–º—ã –∫ `slot_schema` (`List[SlotDefinition]`)

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ `slot_schema`
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π –∏ —Ç–∏–ø–æ–≤ –≤ system / user prompt

### 3. –í—ã–∑–æ–≤ LLM
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ OpenAI (ChatModel) —Å –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π
- –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON (—á–µ—Ä–µ–∑ LangChain)

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è:
  - –í—Å–µ `required` –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
  - –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ (`STRING`, `INT`, `FLOAT`, `BOOL`)
  - –ó–Ω–∞—á–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω—ã—Ö/–æ–ø–∏—Å–∞–Ω–Ω—ã—Ö

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ —Ñ–∞–∫—Ç–æ–≤ (multi-match)

### 6. Fallback / Generate
- –ï—Å–ª–∏ `required` –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:
  - –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º (fallback)
- –ï—Å–ª–∏ –ø–æ–ª–µ `required=False`, –Ω–æ –≤–∞–∂–Ω–æ (e.g. `summary`) ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

---

## üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏

```python
class SlotDefinition(BaseModel):
    name: str
    type: Literal["STRING", "INT", "FLOAT", "BOOL"]
    description: Optional[str] = None
    required: bool = True
    default: Optional[Union[str, int, float, bool]] = None

class CypherTemplate(BaseModel):
    id: str
    title: str
    description: str
    category: Optional[str]
    slots: List[SlotDefinition]
    graph_relation: Optional[GraphRelationDescriptor]
    cypher: str
```

---

## üì§ –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä: –†–∞–∑—Ä—ã–≤ –∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Ñ—Ä–∞–∫—Ü–∏–∏

**–¢–µ–∫—Å—Ç:**
> ¬´–í –≥–ª–∞–≤–µ 15 –ê—Ä–µ–Ω —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç –∫–ª—è—Ç–≤—É —Å –î–æ–º–æ–º –ó–∞—Ä–∏, –∑–∞—è–≤–ª—è—è, —á—Ç–æ –∏—Ö —É—á–µ–Ω–∏—è –±—ã–ª–∏ –ª–æ–∂—å—é. –û–Ω —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã—Ç–æ —Å–∏–º–ø–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –°–µ–≤–µ—Ä–Ω–æ–º—É —Ñ—Ä–æ–Ω—Ç—É.¬ª

**–®–∞–±–ª–æ–Ω:** `CypherTemplate(slots=[character, faction])`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
[
  {"character": "–ê—Ä–µ–Ω", "faction": "–î–æ–º –ó–∞—Ä–∏"},
  {"character": "–ê—Ä–µ–Ω", "faction": "–°–µ–≤–µ—Ä–Ω—ã–π —Ñ—Ä–æ–Ω—Ç"}
]
```

---

## üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ù–µ–≤–µ—Ä–Ω—ã–π JSON –æ—Ç LLM ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (1 –ø–æ–ø—ã—Ç–∫–∞)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `required` –ø–æ–ª–µ–π ‚Üí fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ / —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –í —Å–ª—É—á–∞–µ –ø–æ–ª–Ω–æ–π –Ω–µ—É–¥–∞—á–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `[]`

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞

- `%` —É—Å–ø–µ—à–Ω—ã—Ö –∏–∑–≤–ª–µ—á–µ–Ω–∏–π
- –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π –Ω–∞ —à–∞–±–ª–æ–Ω
- –ß–∏—Å–ª–æ fallback/generative —Å–ª—É—á–∞–µ–≤
- –ü–æ–ª–Ω–æ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è `required` —Å–ª–æ—Ç–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- –¢–µ—Å—Ç—ã –Ω–∞:
  - –æ–¥–Ω–æ –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π
  - fallback / generate –ª–æ–≥–∏–∫—É
  - –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ slot_schema
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤
  - –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö JSON

---

## üß© –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω–∏—Ç—å OpenAI ‚Üí Anthropic, Mistral
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ (`DATE`, `SUMMARY`, `LIST`)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –≥—Ä–∞—Ñ–∞

---

## üß∑ –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

- `README.md`: —Å–µ–∫—Ü–∏—è ¬´Slot Filling Logic¬ª
- `pydantic_models_for_cypher_template.md`: –º–æ–¥–µ–ª–∏ —à–∞–±–ª–æ–Ω–æ–≤ –∏ —Å–≤—è–∑–µ–π
- `pipeline_overview.md`: –æ–±—â–∞—è —Å—Ö–µ–º–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞

---