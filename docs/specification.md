# üìò –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî StoryGraph API

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤ –∏–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –≥—Ä–∞—Ñ–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–∏ —Ñ–∞–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è:

- –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è **—Å—é–∂–µ—Ç–Ω–æ–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏**
- –∏–∑–≤–ª–µ—á–µ–Ω–∏—è **–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏** –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≥–ª–∞–≤—ã
- –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è **—ç–≤–æ–ª—é—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –æ—Ç–Ω–æ—à–µ–Ω–∏–π, —Å–æ–±—ã—Ç–∏–π** –∏ –ø—Ä.

---

## üì¶ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. `/v1/extract-save`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤ –≥—Ä–∞—Ñ.

**–í—Ö–æ–¥**:
- –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç (2‚Äì8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- `chapter` (–Ω–æ–º–µ—Ä –≥–ª–∞–≤—ã)
- `tags` (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–í—ã—Ö–æ–¥**:
- –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤
- ID –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

**–≠—Ç–∞–ø—ã**:
1. üîç –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö `CypherTemplate` –≤ Weaviate (–ø–æ —Å–º—ã—Å–ª—É)
2. üß† LLM-–∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `slots` –ø–æ–¥ `slot_schema`
3. üì• –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π, –æ—Ç–Ω–æ—à–µ–Ω–∏–π)
4. üì§ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è versioned `Fact` (–ø–æ —Ä–µ—à–µ–Ω–∏—é LLM)
5. üßæ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ `IN_CHAPTER`, `TextFragment`, `PRECEDED_BY`
6. üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Langfuse

---

### 2. `/v1/augment-context`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í–æ–∑–≤—Ä–∞—Ç —Ñ–∞–∫—Ç–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞—Å—Å–∫–∞–∑–∞.

**–í—Ö–æ–¥**:
- –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç
- `chapter`
- `tags`

**–í—ã—Ö–æ–¥**:
- JSON —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏ (–ø–µ—Ä—Å–æ–Ω–∞–∂–∏, —Å–≤—è–∑–∏, –º–µ—Å—Ç–æ, —Å–æ–±—ã—Ç–∏—è –∏ —Ç. –¥.)

**–≠—Ç–∞–ø—ã**:
1. üß† LLM-–∏–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è: –∫–∞–∫–∏–µ —Ñ–∞–∫—Ç—ã –Ω—É–∂–Ω—ã
2. üîç –ü–æ–∏—Å–∫ `SELECT`-—à–∞–±–ª–æ–Ω–æ–≤ –≤ Weaviate
3. üß© –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `slots` –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Neo4j
4. üóÇÔ∏è –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
5. üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Langfuse

---

## ‚öôÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                  |
|-------------------|-------------------------------------------------------------|
| `CypherTemplate`  | Jinja2-—à–∞–±–ª–æ–Ω —Å `slot_schema`, —Ç–∏–ø–æ–º —Ñ–∞–∫—Ç–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π      |
| `versioned_fact.j2` | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `Fact`     |
| `TemplateService` | –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–æ–≤ –≤ Weaviate                                   |
| `GraphProxy`      | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Cypher-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Neo4j                          |
| `SlotFiller`      | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `slots` —á–µ—Ä–µ–∑ OpenAI               |
| `ExtractionPipeline` | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è `/extract-save`                             |
| `AugmentPipeline` | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è `/augment-context`                             |

---

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤ (`CypherTemplate`)

```json
{
  "id": "char_confession",
  "cypher": "...",
  "slot_schema": {
    "actor": "STRING",
    "target": "STRING",
    "emotion": "STRING"
  },
  "fact_policy": "auto",
  "fact_type": "EMOTION",
  "fact_value_slot": "emotion"
}
```

---

## üíæ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ `:Fact`)

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω `versioned_fact.j2`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è `from_chapter`, `to_chapter`, `PRECEDED_BY`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏:
  - `fact_policy = always`, –∏–ª–∏
  - LLM —Ä–µ—à–∞–µ—Ç `auto`-—à–∞–±–ª–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —Ñ–∞–∫—Ç

---

## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

- –ü—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω (–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `.env`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FastAPI `Depends(...)` –¥–ª—è –∑–∞—â–∏—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã –Ω–∞:
  - –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤
  - –≥–µ–Ω–µ—Ä–∞—Ü–∏—é `slots`
  - —à–∞–±–ª–æ–Ω—ã —Å –∏ –±–µ–∑ —Ñ–∞–∫—Ç–æ–≤
  - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–≥–ª–∞–≤—ã, —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, —Å—É—â–Ω–æ—Å—Ç–∏)

---

## üìà –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –°–µ—Ä–≤–∏—Å     | –¶–µ–ª—å                        |
|------------|-----------------------------|
| Neo4j      | –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ |
| OpenAI API | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤, —Ä–µ—à–µ–Ω–∏–π |
| Weaviate   | –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤    |
| Langfuse   | –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö LLM-–∑–∞–ø—Ä–æ—Å–æ–≤ |