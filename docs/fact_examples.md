# ðŸ“š ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° `extract-save`

## ðŸ§© ÐŸÑ€Ð¸Ð¼ÐµÑ€ 1: Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð°Ð»ÑŒÑÐ½ÑÐ° Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð°

**Ð’Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚:**

> Â«Ð’ Ð³Ð»Ð°Ð²Ðµ 15 ÐÑ€ÐµÐ½ Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ»ÑÑ‚Ð²Ñƒ Ñ Ð”Ð¾Ð¼Ð¾Ð¼ Ð—Ð°Ñ€Ð¸, Ð·Ð°ÑÐ²Ð»ÑÑ, Ñ‡Ñ‚Ð¾ Ð¸Ñ… ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ñ‹Ð»Ð¸ Ð»Ð¾Ð¶ÑŒÑŽ. ÐžÐ½ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾ ÑÐ¸Ð¼Ð¿Ð°Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð¡ÐµÐ²ÐµÑ€Ð½Ð¾Ð¼Ñƒ Ñ„Ñ€Ð¾Ð½Ñ‚Ñƒ.Â»

**ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ:** `chapter=15`, `tags=["Ñ€Ð°Ð·Ñ€Ñ‹Ð²", "Ð°Ð»ÑŒÑÐ½Ñ", "Ñ€Ð°ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ"]`

### Ð­Ñ‚Ð°Ð¿Ñ‹ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°

1. **Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ `ChunkNode`.**
   ```cypher
   CREATE (c:Chunk {
     id: $chunk_id,
     text: $text,
     chapter: 15,
     draft_stage: "brainstorm",
     tags: ["Ñ€Ð°Ð·Ñ€Ñ‹Ð²", "Ð°Ð»ÑŒÑÐ½Ñ", "Ñ€Ð°ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ"],
     raptor_node_id: NULL
   })
   ```
2. **ÐŸÐ¾Ð¸ÑÐº ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð².** `TemplateService` Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ `membership_change.j2` Ð¿Ð¾ Ð²ÐµÐºÑ‚Ð¾Ñ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
3. **Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÐ»Ð¾Ñ‚Ð¾Ð².** `SlotFiller` Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚:
   ```json
   {"character": "ÐÑ€ÐµÐ½", "faction": "Ð¡ÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ñ€Ð¾Ð½Ñ‚"}
   ```
   Ð¸
   ```json
   {"character": "ÐÑ€ÐµÐ½", "faction": "Ð”Ð¾Ð¼ Ð—Ð°Ñ€Ð¸"}
   ```
4. **IdentityService.** Ð’ÑÐµ Ð¸Ð¼ÐµÐ½Ð° ÑÐ¾Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ Ñ `entity_id`, ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ÑÑ Ð·Ð°Ð¿Ð¸ÑÐ¸ `AliasRecord` Ñ `chunk_id`.
5. **Raptor ÑÐ»Ð¾Ð¹.** `flat_raptor.insert_chunk(text_vec, fact_vec)` Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ `raptor_node_id`, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð¿Ð¾Ð»Ðµ `ChunkNode.raptor_node_id`.
6. **Ð ÐµÐ½Ð´ÐµÑ€ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Cypher.** Ð¨Ð°Ð±Ð»Ð¾Ð½ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ²ÑÐ·Ð¸ `MEMBER_OF` Ð¸ `MENTIONS` Ñ‡ÐµÑ€ÐµÐ· `chunk_mentions.j2`:
   ```cypher
   MERGE (a:Character {id: "UUID-123"})
   MERGE (b:Faction {id: "UUID-456"})
   MERGE (a)-[:MEMBER_OF {chapter: 15, chunk_id: $chunk_id}]->(b)
   MATCH (chunk:Chunk {id: $chunk_id})
   MERGE (chunk)-[:MENTIONS]->(a)
   MERGE (chunk)-[:MENTIONS]->(b)
   ```
7. **GraphProxy.** Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÐµÑÑŒ Cypher Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸.

Ð˜Ñ‚Ð¾Ð³Ð¾Ð¼ ÑÐ²Ð»ÑÐµÑ‚ÑÑ `chunk_id` Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ Ð¸ `raptor_node_id` Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ³Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.

---

## ðŸ“¤ ÐŸÑ€Ð¸Ð¼ÐµÑ€ 2: ÐÑƒÐ³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÑÐ²ÑÐ·ÐµÐ¹

**Ð’Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚:**

> Â«Ð­Ñ€Ð¸Ðº ÐºÐ¾Ð»ÐµÐ±Ð»ÐµÑ‚ÑÑ. ÐžÐ½ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ ÑƒÐ²ÐµÑ€ÐµÐ½, Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð»Ð¸ ÐµÐ³Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ â€” ÐµÐ³Ð¾ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ. Ð§Ñ‚Ð¾ Ð±Ñ‹ ÑÐºÐ°Ð·Ð°Ð»Ð° ÐœÐ¸Ñ€Ð°Ð½Ð´Ð°?Â»

**ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ:** `chapter=19`, `tags=["ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚", "Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ"]`

1. `TemplateService` Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÐµÑ‚ SELECT-ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹ (`has_trait_select`, `influence_select`).
2. `SlotFiller` Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ ÑÐ»Ð¾Ñ‚Ñ‹:
   ```json
   {"subject": "ÐœÐ¸Ñ€Ð°Ð½Ð´Ð°", "chapter": 19}
   {"subject": "ÐœÐ¸Ñ€Ð°Ð½Ð´Ð°", "target": "Ð­Ñ€Ð¸Ðº", "chapter": 19}
   ```
3. Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÑŽÑ‚ Cypher-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð±ÐµÐ· ÑƒÑ‡Ð°ÑÑ‚Ð¸Ñ `Fact`-Ð½Ð¾Ð´. Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÑŽÑ‚ÑÑ Ð¸Ð· Ð¿Ñ€ÑÐ¼Ñ‹Ñ… ÑÐ²ÑÐ·ÐµÐ¹:
   ```cypher
   MATCH (p:Character {id: "UUID_M"})-[:HAS_TRAIT]->(t:Trait)
   WHERE t.chapter <= 19
   RETURN t.name
   ```
4. ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ ÑÐ²ÐµÐ´ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸ Ð² ÑÑ†ÐµÐ½Ðµ.
