# Store template score in relationships

## Цель
Записать величину `score` из подбора шаблонов в свойства связей Neo4j.

## Контекст
`TemplateService.top_k` возвращает найденные шаблоны по релевантности, но
оценка не сохранялась в графе. Это затрудняло анализ качества поиска.

## Мотивация
Хранение `score` позволит отслеживать, почему выбран тот или иной шаблон и
сравнивать эффективность разных настроек гибридного поиска.

## Польза
Каждая связь будет содержать `score` с точностью до шаблона, что упростит
отладку и последующую аналитическую обработку данных.

## Планируемые изменения
- Добавить поле `score` в модель `CypherTemplate`.
- При чтении из Weaviate сохранять `metadata.score` в это поле.
- В `_process_template` прокидывать `score` в мета‑данные рендера и в
  возвращаемые описания связей.
- В шаблон `_relation_meta.j2` включить свойство `score`.

## Локация
- `app/schemas/cypher.py`
- `app/services/templates/__init__.py`
- `app/services/pipeline.py`
- `app/templates/cypher/_relation_meta.j2`

## Альтернативы
Можно было бы возвращать пару `(template, score)` из `TemplateService`, но
добавление поля проще и не ломает существующий интерфейс.

## Деплой
После обновления кода перезагрузить сервис, чтобы новые свойства появились в
создаваемых связях. Миграции не требуются.

## Проверка
- Юнит‑тесты `pytest -q` должны проходить.
- Связи в Neo4j получают новое поле `score` со значением от Weaviate.

## Меры на будущее
Продумать метрики, учитывающие `score`, и добавить тесты на корректность
значения при разных настройках поиска.

## Отчёт
После внедрения в графе фиксируются связи со свойством `score`, равным
рейтингу выбранного шаблона.
