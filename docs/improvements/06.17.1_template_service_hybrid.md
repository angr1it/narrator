# Hybrid Retrieval in TemplateService

## Резюме
Цель: **уменьшить шум** в подборе шаблонов к входному тексту, **повысить точность** сопоставления без потери полноты (recall), **не привнося дорогих изменений** в инфраструктуру или обучение.

## Что включает этап

### 1. **Гибридный поиск (Hybrid Retrieval)**

**Идея:** объединение векторного (dense) и ключевого (sparse/BM25) поиска для повышения точности подбора шаблонов.

* **Как работает:**

  * Вместо только `nearVector` в Weaviate, используется `hybrid` запрос (поддерживается напрямую).
  * Для каждого шаблона в базе хранятся:

    * Вектор описания, полученный из объединения `description` и ключевых слов:

      ```
      representation = f"{description} Keywords: {' '.join(keywords)}"
      ```
    * `keywords` — участвует в BM25-поиске как отдельное текстовое поле.
  * Запрос пользователя обрабатывается:

    * Семантически — ищутся шаблоны с близким эмбеддингом.
    * Ключевыми словами — ищутся шаблоны, содержащие лексические совпадения.
  * Итоговый скор для каждого шаблона — агрегированная мера из обоих источников:

    ```
    hybrid(query=text, vector=embedding, alpha=α)
    ```
  * **Важно:** параметр `alpha` определяет вклад каждого компонента:

    * `alpha ≈ 0.5` — сбалансировано
    * `alpha > 0.7` — делает упор на векторное сходство
    * `alpha < 0.3` — делает упор на лексические совпадения (BM25)
    * Подбор оптимального значения требует экспериментального тестирования.

* **Преимущества:**

  * Векторный поиск хорошо ловит синонимы, общую тему.
  * BM25-фильтрация снижает ложные срабатывания между схожими по смыслу, но различными по ключевым словам шаблонами.
  * Без обучения, быстро и легко встраивается в текущий стек.

### 2. **Prompt-/Phrase-Engineered описания шаблонов (ключевые слова)**

**Идея:** заменить/дополнить текущие текстовые описания шаблонов списком тематических ключевых слов и фраз, отражающих сущность шаблона.

* **Как работает:**

  * В `app/templates/base.py` каждому шаблону задаётся:

    * `keywords`: список ключевых слов, например `["предательство", "обман", "измена"]`.
    * Это дополняет поле `description`.
  * Эти ключевые слова:

    * Участвуют в BM25-поиске (через текстовый индекс в Weaviate).
    * Также **включаются в генерацию векторного представления** шаблона.
  * Можно вручную составить такие фразы, либо сгенерировать через LLM (например: *"перечисли ключевые слова, связанные с фактом раскрытия тайны персонажем"*).

* **Преимущества:**

  * Повышает релевантность как лексического, так и семантического поиска.
  * Упрощает настройку – можно "направить" шаблон в нужную зону смыслового пространства без изменения Cypher.
  * Можно постепенно расширять и проверять эмпирически.

## Как это встроится в текущий `TemplateService`

| Этап                           | До                                           | После                                                           |
| ------------------------------ | -------------------------------------------- | --------------------------------------------------------------- |
| Инициализация шаблонов         | Чтение `description` и `example` → эмбеддинг | Добавляется `keywords` → включается в BM25 и вектор |
| Индексация шаблонов в Weaviate | `vector` + `name`, `description`             | `vector` + `name`, `keywords` (BM25)                |
| Запрос через `top_k()`         | `nearVector(vector)`                         | `hybrid(query=text, vector=vector, alpha=0.5)`                  |
| Выход                          | K ближайших шаблонов по вектору              | K наиболее релевантных шаблонов по гибридному скору             |

## Требования для доработки

### 1. **Добавить поле `keywords` в шаблоны**

* Тип: список строк
* Формат: ключевые слова или фразы
* Источник:

  * Ручная разметка (начать с приоритетных шаблонов)
  * (Опционально) генерация с помощью LLM по шаблону
* Удалить прежнее поле `details` из шаблонов и схем.
  Модель `CypherTemplateBase` формирует поле `representation` из
  `description` и `keywords`, что используется для генерации вектора.

### 2. **Обновить пайплайн индексации шаблонов в Weaviate**

* Хранить `keywords` как `text[]`-поле
* Настроить его как BM25-индексируемое

### 3. **Изменить `top_k()` в `TemplateService`**

* Вместо `nearVector()` использовать `hybrid`-поиск:

  * `query = текст пользователя`
  * `vector = эмбеддинг текста`
  * `alpha = 0.5` (тестировать и варьировать)
* Отдавать top-N шаблонов по агрегированной релевантности

### 4. **(Необязательно) Тестовый модуль для оценки качества**

* Метрики: precision@1, presence of target template, avg. noise
* Сценарий: тестировать на заранее размеченных примерах

## Прогнозируемый эффект

* Существенное снижение шума: шаблоны, не содержащие ключевых слов, **не попадут в top-K**.
* Улучшение покрытия: за счёт ключевых слов можно покрыть лексически далёкие, но по смыслу близкие входы.
* Уточнённые векторные представления повысят точность сопоставления.
* Без ML-обучения, полностью инженерная реализация, быстрая обратная связь.

## Цель
Уменьшить число нерелевантных шаблонов в результатах `TemplateService` и повысить точность совпадения с входным текстом.

## Контекст
Существующий поиск опирается только на векторное сходство в Weaviate. Это приводит к попаданию близких по тематике, но неверных по деталям шаблонов. Доработка нужна в рамках совершенствования `TemplateService` без существенных изменений инфраструктуры.

## Мотивация
Текущий подход не различает похожие по смыслу шаблоны и генерирует лишний шум. Комбинация dense и BM25-поиска должна повысить precision без ухудшения recall, что критично для качества результатов.

## Польза
Сервис станет точнее подбирать релевантные шаблоны, опираясь на ключевые слова и семантику. Векторная часть сохранит способность работать с синонимами, а ключевые слова отфильтруют неподходящие варианты.

## Планируемые изменения
- В шаблоны добавить поле `keywords` со списком ключевых слов.
- При индексировании передавать `description` и ключевые слова в генерацию вектора и хранить `keywords` как `text[]` для BM25.
- В методе `top_k()` использовать `hybrid` запрос вместо чисто векторного.
- Подобрать значение `alpha` экспериментально, начав с `0.5`.
- Обновить все записи в `base_templates`, добавив новое поле с ключевыми словами
  (по несколько терминов для каждого шаблона).
- (Опционально) создать тестовый модуль для оценки precision и уровня шума.

## Локация
- Файлы шаблонов в `app/templates`.
- Логика индексации и поиска в `TemplateService` и связанных клиентах Weaviate.
- Класс `CypherTemplateBase` и структура `base_templates`.

## Альтернативы
- Использовать только ключевой поиск. Но это ухудшит работу с переформулированными запросами.
- Подбирать шаблоны через предварительное обучение отдельной модели, что дороже и сложнее в поддержке.

## Деплой
- Пересоздать коллекции Weaviate с новым полем и настройками BM25.
- Обновить конфигурацию сервиса на использование гибридного запроса.

## Проверка
- Unit-тесты на корректность индексации и поиск по гибридному запросу.
- При наличии размеченных примеров замерить precision@1 и количество шумовых результатов.

## Тестовый модуль
Модуль оценит качество гибридного поиска на наборе размеченных запросов.
Он будет вызывать `top_k()` и собирать показатели precision@1 и долю шумовых
совпадений. Сценарии тестов оформляются как фикстуры, что позволит быстро
сравнивать результаты при изменении `alpha` и расширении словаря ключевых слов.

## Меры на будущее
- Поддерживать и расширять список ключевых слов для шаблонов.
- Дополнить документацию о порядке настройки Weaviate и параметре `alpha`.

## Отчёт
После внедрения ожидается снижение нерелевантных совпадений и более точное соответствие шаблонов тексту пользователя.
