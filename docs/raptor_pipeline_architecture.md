# ðŸ§  RAPTOR Extraction Pipeline â€” ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¸ Ð’Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

## ðŸ—‚ ÐžÐ±Ñ‰Ð¸Ð¹ ÐžÐ±Ð·Ð¾Ñ€

Ð¦ÐµÐ»ÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° â€” Ð¸Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÑŒ **ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ** (Ñ„Ð°ÐºÑ‚Ñ‹) Ð¸Ð· Ð½Ð°Ñ€Ñ€Ð°Ñ‚Ð¸Ð²Ð° Ð¸ Ð¿Ñ€Ð¾ÐµÑ†Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ñ… Ð² **Ð³Ñ€Ð°Ñ„ Ð·Ð½Ð°Ð½Ð¸Ð¹** (Neo4j) + **ÑÐµÐ¼Ð°Ð½Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¸Ð½Ð´ÐµÐºÑ** (Weaviate).  
ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ versioning, aliasing, filtering Ð¿Ð¾ Ð³Ð»Ð°Ð²Ð°Ð¼ Ð¸ ÑÑ‚Ð°Ð´Ð¸ÑÐ¼ (`StageEnum`), traceability Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€Ð½Ð¾ÑÑ‚Ð¸ (`confidence`, `canonical`).

---

## ðŸ”„ ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¸ ÐŸÐ¾Ñ‚Ð¾Ðº Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

### 1. `TemplateService`
- Ð˜Ñ‰ÐµÑ‚ top-K ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² (`CypherTemplate`) Ð¿Ð¾ Ð²ÐµÐºÑ‚Ð¾Ñ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
- ÐŸÐµÑ€ÐµÐ´Ð°Ñ‘Ñ‚ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹ Ð´Ð°Ð»ÑŒÑˆÐµ Ð² `SlotFiller`.

---

### 2. `SlotFiller`
- ÐŸÑ€Ð¾Ð³Ð¾Ð½ÑÐµÑ‚ 3 Ñ„Ð°Ð·Ñ‹ (`extract`, `fallback`, `generate`) Ñ‡ÐµÑ€ÐµÐ· LLM.
- Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº `SlotFill`:
  ```json
  {
    "template_id": "...",
    "slots": {"character": "ÐÑ€ÐµÐ½", "trait": "Ñ…Ñ€Ð°Ð±Ñ€Ñ‹Ð¹"},
    "details": "via extraction"
  }
  ```

---

### 3. `IdentityService.process_slot_fills()`
- ÐÐ°Ñ…Ð¾Ð´Ð¸Ñ‚ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ `alias`-Ñ‹ Ð² Weaviate.
- ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚:
  - Ð½Ð¾Ð²Ñ‹Ðµ `entity_id`;
  - Cypher-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° Ð²ÑÑ‚Ð°Ð²ÐºÑƒ Ð² Neo4j;
  - Ð·Ð°Ð¿Ð¸ÑÐ¸ `Alias` Ð² Weaviate.
- Ð’Ñ‹Ð´Ð°Ñ‘Ñ‚:
  - Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ðµ `SlotFill` (Ð²ÑÐµ Ð¸Ð¼ÐµÐ½Ð° â†’ `entity_id`);
  - `alias_cypher[]` (Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ´ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð¼).

---

### 4. `TemplateRenderer`
- Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ñ‚ **ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ Cypher** Ð¸Ð· `CypherTemplate` Ð¸ `SlotFill`.
- Ð¢Ð°ÐºÐ¶Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ `return_map` (ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÐºÐ»ÑŽÑ‡ÐµÐ¹ â†” UID Ð² Ð³Ñ€Ð°Ñ„Ðµ).

---

### 5. `GraphProxy`
- Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° `alias_cypher`, Ð·Ð°Ñ‚ÐµÐ¼ `content_cypher`.
- Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ UID-Ñ‹ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹.

---

### 6. `FactBuilder`
- ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð° + `return_map` ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ **versioned Ñ„Ð°ÐºÑ‚**:
  - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ `MERGE` Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼Ð¸,
  - `SET active = false`,
  - ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð½Ð¾Ð²Ñ‹Ð¹ `(:Fact)` Ñ `stage`, `tags`, `from_chapter`, `to_chapter`.

---

### 7. `GraphProxy` (Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð²Ñ‹Ð·Ð¾Ð²)
- Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ `fact_cypher`.

---

## ðŸ§© ÐžÐ±ÑŠÐµÐºÑ‚Ñ‹ Ð¸ ÑÐ²ÑÐ·Ð¸

- `(:Alias)` â€” Ð²ÑÐµÐ³Ð´Ð° ÑÐ²ÑÐ·Ð°Ð½ Ñ `(:Character|Location|Faction)` Ñ‡ÐµÑ€ÐµÐ· `:REFERS_TO`
- `(:Fact)` â€” ÑÐ²ÑÐ·Ð°Ð½ Ñ `(:Alias)` Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼Ð¸ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸
- `(:Fact)` Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð¼ÐµÑ‚ÑŒ `PRECEDED_BY` Ðº ÑÑ‚Ð°Ñ€Ñ‹Ð¼ Ð²ÐµÑ€ÑÐ¸ÑÐ¼
- `canonical` Ð¸ `confidence` ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‚ Ð·Ñ€ÐµÐ»Ð¾ÑÑ‚ÑŒÑŽ alias

---

## âœ… ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

1. Ð’Ð²Ð¾Ð´: `"ÐÑ€ÐµÐ½ ÑÑ€Ð°Ð¶Ð°Ð»ÑÑ ÑÐ¼ÐµÐ»Ð¾"`
2. ÐÐ°Ð¹Ð´ÐµÐ½ ÑˆÐ°Ð±Ð»Ð¾Ð½ `character_trait`
3. Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¾:
   ```json
   { "character": "ÐÑ€ÐµÐ½", "trait": "Ñ…Ñ€Ð°Ð±Ñ€Ñ‹Ð¹" }
   ```
4. `IdentityService`:
   - ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ `character-xxx`
   - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ `Alias`
   - Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Cypher
5. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ `alias_cypher`
6. Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ñ‚ÑÑ `content_cypher`: `(:Character)-[:HAS_TRAIT]->(:Trait)`
7. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ `content_cypher`
8. `FactBuilder` ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ `versioned_fact`
9. Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ `(:Fact)`

---

## ðŸ›  ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ

- `stage`: `StageEnum` (-1 â†’ brainstorm, 0 â†’ outline, ..., 11 â†’ final)
- `chapter`, `to_chapter`: Ð´Ð»Ñ Ñ…Ñ€Ð¾Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¸
- `tags`: Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸
- `details`: trace Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÐ¸ Ñ€Ð°ÑÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ð¹

---

## ðŸ“Œ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

- ðŸ” Idempotency Ñ‡ÐµÑ€ÐµÐ· `MERGE`
- ðŸ§  LLM Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ **Ñ‚Ð¾Ð»ÑŒÐºÐ¾** Ð¿Ñ€Ð¸ Ð½ÐµÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… alias
- ðŸ” Ð’ÑÐµ `entity_id` ÐºÐ°Ð½Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
- ðŸ“’ ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ Ñ‚Ñ€Ð°ÑÑÐ¸Ñ€Ð¾Ð²ÐºÐ°: `fact -> slot_fill -> template -> text`

---