–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è ‚Äî –≤—ã–Ω–æ—Å–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –≥—Ä–∞—Ñ–æ–≤—ã–µ —Å–≤—è–∑–∏ –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π `base.j2`-—à–∞–±–ª–æ–Ω, –∞ **–¥–æ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã** (`membership_change`, `status_update`, –∏ —Ç.–¥.) –¥–µ–ª–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏ (`MERGE`, `MATCH`, –∏ –ø—Ä.). –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:

- —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ —Å `ChunkNode` –∏ –∏—Ö traceability,
- —Å–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –≤—Å—Ç–∞–≤–∫–∏ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (`template_id`, `chapter`, `chunk_id`, `description`, `draft_stage`, `confidence`),
- –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤ ‚Äî –µ–¥–∏–Ω—ã–π ¬´–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä-—Å–≤—è–∑—å¬ª.

---

## ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤

### 1. –ß—Ç–æ —Ç–∞–∫–æ–µ —à–∞–±–ª–æ–Ω (CypherTemplate)

–®–∞–±–ª–æ–Ω ‚Äî —ç—Ç–æ Jinja2-–æ–ø–∏—Å–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Ñ—Ä–∞–∫—Ü–∏–∏, –ø–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ —Ç.–¥.), –∫–æ—Ç–æ—Ä–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Cypher-–∫–æ–¥.

### üß© –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è `related_node_ids`

–ü–æ–ª–µ `related_node_ids` ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ ID —Å—É—â–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –∏ –≥—Ä–∞—Ñ–æ–≤–æ —Å–≤—è–∑–∞–Ω—ã —Å `ChunkNode`. –û–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ `render()`:

- –µ—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω–µ –∑–∞–¥–∞–Ω `graph_relation`, —Å–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `subject` –∏ `object`, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ `slots` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ `related_node_ids`;
- —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω—É–∂–Ω—ã–µ MATCH- –∏ MENTIONS-–±–ª–æ–∫–∏ –≤ `chunk_mentions.j2`, –¥–∞–∂–µ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞ –∏—Ö –Ω–µ –ø—Ä–æ–ø–∏—Å–∞–ª —è–≤–Ω–æ;
- —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é –≤ Jinja (`{% set related_node_ids = [...] %}`), —á—Ç–æ –¥–∞—ë—Ç –≥–∏–±–∫–æ—Å—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

### 2. `chunk_mentions.j2` ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–∞–º–∫–∞ —à–∞–±–ª–æ–Ω–∞

```
// chunk_mentions.j2

{% include "templates/{{ template_id }}.j2" %}

WITH *
// --- —Å–≤—è–∑–∏ —Å Chunk ---
MATCH (chunk:Chunk {id: "{{ chunk_id }}"})

{% for node_id in related_node_ids %}
  MATCH (x{{ loop.index }} {id: "{{ node_id }}"})
{% endfor %}
{% for node_id in related_node_ids %}
  MERGE (chunk)-[:MENTIONS]->(x{{ loop.index }})
{% endfor %}
```

–ó–¥–µ—Å—å `MATCH`‚Äë–±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ `MERGE`. –ü–∞–π–ø–ª–∞–π–Ω —Ä–∞–∑–±–∏–≤–∞–µ—Ç
—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É ``WITH *`` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç
–∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –≠—Ç–æ –æ–±—Ö–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Neo4j –Ω–∞
–∫–æ–º–±–∏–Ω–∞—Ü–∏—é `MERGE` –∏ `MATCH` –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.

### üîç –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ü–∏–∫–ª `for node_id in related_node_ids`

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ç–æ, —á—Ç–æ–±—ã:

1. **–°–≤—è–∑–∞—Ç—å –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ —à–∞–±–ª–æ–Ω–µ, —Å \`\`.** –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç `MENTIONS`-—Å–≤—è–∑–∏ –º–µ–∂–¥—É —á–∞–Ω–∫–æ–º –∏ –∫–∞–∂–¥–æ–π –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é (–ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º, —Ñ—Ä–∞–∫—Ü–∏–µ–π –∏ —Ç.–ø.).
2. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ MATCH-–±–ª–æ–∫–∞—Ö, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∫–∞–∫ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.**
3. **–ê–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–æ–¥.** –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `x{{ loop.index }}` ‚Äî —ç—Ç–æ –æ–±–æ–±—â—ë–Ω–Ω–∞—è –Ω–æ–¥–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ –∑–Ω–∞–Ω–∏—è –µ—ë —Ç–∏–ø–∞ (`:Character`, `:Faction`, –∏ —Ç.–¥.).
4. **–§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–≤—è–∑–Ω–æ—Å—Ç—å –≥—Ä–∞—Ñ–∞.** –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ `ChunkNode` –Ω–∞—Ö–æ–¥–∏—Ç—å –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ –Ω—ë–º –±—ã–ª–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã.

---

### 3. –î–æ–º–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω: `membership_change.j2`

```
// templates/membership_change.j2

MERGE (a:Character {id: "{{ character }}"})
MERGE (b:Faction {id: "{{ faction }}"})
MERGE (a)-[r:MEMBER_OF {
    chapter: {{ chapter }},
    template_id: "membership_change",
    description: "{{ description }}",
    chunk_id: "{{ chunk_id }}",
    draft_stage: "{{ draft_stage }}",
    confidence: {{ confidence }}
}]->(b)

{% set related_node_ids = [character, faction] %}
```

---

## üìå –ò—Ç–æ–≥: –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. `TemplateService` –≤—ã–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω `membership_change` –ø–æ ID.
2. –ü–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º `jinja`, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç:
   ```
   template_context = {
       "template_id": "membership_change",
       "chunk_id": "chunk-abc",
       "chapter": 5,
       "description": "–ê—Ä–µ–Ω –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –ù–æ—á–Ω–æ–º—É —Ñ—Ä–æ–Ω—Ç—É.",
       "draft_stage": "brainstorm",
       "confidence": 0.2,
       "character": "UUID-1",
       "faction": "UUID-2",
       "related_node_ids": ["UUID-1", "UUID-2"]
   }
   ```
3. –†–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ `membership_change.j2`, –∑–∞—Ç–µ–º –æ–Ω **–≤–∫–ª—é—á–∞–µ—Ç—Å—è** –≤ `chunk_mentions.j2`.

---

### –û—Å—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤

(—Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã ‚Äî –ø—Ä–∏–º–µ—Ä—ã —à–∞–±–ª–æ–Ω–æ–≤ `membership_change.j2`, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ `{% for node_id in related_node_ids %}` –∏ —Ç.–¥.)

---

## üîß –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ base\_fact.j2 –≤ config-layer

-–ß—Ç–æ–±—ã `chunk_mentions.j2` –±—ã–ª–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –∏ –ø–æ–¥–∫–ª—é—á–∞–ª–æ—Å—å –ø–æ —Ñ–ª–∞–≥—É, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–ª—è `use_base_extract` –∏ `use_base_augment` –≤ `CypherTemplateBase`.
-–ü—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ (–≤ `render()` –∏–ª–∏ TemplateService) `chunk_mentions.j2` –∑–∞–¥–∞—ë—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —à–∞–±–ª–æ–Ω, –∞ –¥–æ–º–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω ‚Äî –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–æ–∫ `include`.
- —ç—Ç–æ –¥–∞—Å—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å `chunk_mentions` –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö (alias/identity) —à–∞–±–ª–æ–Ω–æ–≤.



\---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —à–∞–±–ª–æ–Ω–æ–≤

–ú–æ–¥–µ–ª–∏ `CypherTemplate`, `SlotDefinition`, `GraphRelationDescriptor` —Ö–æ—Ä–æ—à–æ —Å–æ–≥–ª–∞—Å—É—é—Ç—Å—è —Å –∏–¥–µ–µ–π –≤—ã–Ω–µ—Å–µ–Ω–∏—è –æ–±—â–µ–π –ª–æ–≥–∏–∫–∏ (`MATCH Chunk`, `MENTIONS`, `traceability`) –≤ `chunk_mentions.j2`:

- ‚úÖ –ø–æ–ª—è `extract_cypher` –∏ `augment_cypher` –∑–∞–¥–∞—é—Ç Jinja‚Äë—à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤; `use_base_extract` –∏ `use_base_augment` —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–±—ë—Ä—Ç–∫–æ–π `chunk_mentions.j2`.
- ‚úÖ `graph_relation` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (triple\_text) –∏ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ `fact_vec` –∏ `related_node_ids`.
- ‚úÖ `render()` —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ—Ç `related_node_ids` –∏–∑ `graph_relation` –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã —è–≤–Ω–æ.
- ‚úÖ `RenderedCypher` —Ä–∞–∑–¥–µ–ª—è–µ—Ç `content_cypher`, `fact_cypher`, `alias_cypher`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–æ—Å—Ç–∞–≤–Ω—ã–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏.

üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

- `TemplateService` –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ª–æ–≥–∏–∫–æ–π –≤–∫–ª—é—á–µ–Ω–∏—è `chunk_mentions.j2` —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ —à–∞–±–ª–æ–Ω–∞.
- –†–∞—Å—à–∏—Ä–∏—Ç—å `fact_policy`, —á—Ç–æ–±—ã –æ–Ω –≤–ª–∏—è–ª –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ postprocessing, –Ω–æ –∏ –Ω–∞ –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
