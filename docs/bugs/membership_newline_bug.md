# Membership augment newline bug

## Проблема
При вызове `/augment-context` для шаблона `membership_change_aug_v1.j2` падает `CypherSyntaxError`.
Логи содержат фрагмент запроса `WHERE true AND r.chapter <= 1WITH r, f`.

## Контекст
Файл `membership_change_aug_v1.j2` подключает `_augment_filters.j2` перед оператором `WITH`:

```
{% include "_augment_filters.j2" %}
WITH r, f
```

Jinja2 настроен с `trim_blocks=True`, поэтому пустая строка между блоком и `WITH` удаляется.
Получается строка без пробела и Neo4j не может распознать `WITH`.

## Причина
Блок `_augment_filters.j2` заканчивается конструкцией `{% endif %}`.
Из-за `trim_blocks` завершающий перевод строки опускается и текст `WITH r, f` склеивается с предыдущим.

## Последствия
Эндпоинт `/augment-context` возвращает 500.
Запросы к графу не выполняются.

## Планируемые изменения
Добавить пустую строку после включения `_augment_filters.j2`.
Это сохранит перевод строки даже при `trim_blocks`.

## Локация
- `app/templates/cypher/membership_change_aug_v1.j2`

## Улучшения
Рассмотреть переход на подзапросы `CALL {}` чтобы не разделять шаблоны вручную.

## Деплой
Пересобрать контейнер, миграций не требуется.

## Проверка
- `pytest -q`
- Ручной вызов `/augment-context` для текста и главы 1 должен вернуть ответ без ошибки.

## Отчёт
После исправления запрос рендерится как:

```
MATCH (c:Character {id: "x"})-[r:MEMBER_OF]->(f:Faction)
WHERE true AND r.chapter <= 1
WITH r, f
```

Neo4j принимает такой синтаксис без ошибок.

## Дополнительная проверка
Просмотрены все шаблоны в каталоге `app/templates/cypher`.
Поиск выполнялся командой `grep -n "{% include" -R app/templates/cypher`.
Для каждого найденного файла проверялось содержимое после блока `include`.
Только `membership_change_aug_v1.j2` выводит Cypher‑оператор `WITH` сразу после
`_augment_filters.j2`, поэтому там потребовалась пустая строка.
Файл `_augment_meta.j2` уже содержит пробел перед `OPTIONAL MATCH`, что
предотвращает аналогичную склейку. В остальных шаблонах после включения идут
лишь блоки `{% set ... %}`, которые не печатают текст, поэтому проблема не
повторяется.
Отдельно отрендерены все `*_aug_v1.j2` шаблоны и проверено, что строки вроде
`LIMIT 1OPTIONAL MATCH` не встречаются.
Похожий баг ранее исправлялся для `chunk_mentions.j2` (commit `6cf0385`).

## Тесты
Добавлены юнит-тесты `test_membership_filters_newline` и
`test_augment_meta_optional_space`, которые рендерят шаблон и проверяют,
соответственно, наличие переноса перед `WITH r, f` и пробела перед
`OPTIONAL MATCH`.

