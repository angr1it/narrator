# Bug Report: TemplateService distance misused

## Проблема
В `TemplateService.top_k` неверно интерпретируется `distance` из Weaviate. Результаты фильтруются по условию `distance > threshold`, что оставляет самые далёкие совпадения. При логировании функция `log_low_score_warning` выводит значения `distance` как "score" и сортирует их по возрастанию, поэтому скоры отображаются от меньшего к большему.

## Контекст
При поиске подходящих шаблонов метод `top_k` выполняет `near_vector`/`near_text` запрос к Weaviate с `return_metadata(distance=True, score=True)`. Возвращённые значения `distance` меньше для более похожих шаблонов, однако код трактует их как скоры и использует обратное сравнение.

## Причина
Неправильное понимание метрик Weaviate: `distance` используется как мера сходства и сравнивается "наоборот". Аналогично в предупреждении о низком качестве вместо `score` выводится `distance`.

## Последствия
Хорошие шаблоны могут отфильтровываться, а лог отображает некорректные скоры. Это снижает точность выбора темплейтов и усложняет отладку.

## Планируемые изменения
- Заменить условие фильтрации на `obj.metadata.distance < distance_threshold` или использовать `obj.metadata.score`.
- В `log_low_score_warning` передавать список `obj.metadata.score` и выводить результаты по убыванию.
- Повысь значения `distance_threshold` и `top_distance_threshold_warn` по умолчанию до `0.75`.
- Добавить тесты для `top_k`, проверяющие корректный порядок и фильтрацию.

## Локация
- `app/services/templates/__init__.py` – метод `top_k`.
- `app/services/templates/warning.py` – функция `log_low_score_warning`.

## Улучшения
Можно полностью использовать `metadata.score` и избавиться от ручного расчёта `1 - distance` в других частях кода, чтобы избежать путаницы.

## Деплой
Обновление зависит только от изменения кода, миграций не требуется.

## Проверка
- Прогнать `pytest -q` и убедиться, что новые тесты проходят.
- В логах `log_low_score_warning` результаты должны выводиться от большего `score` к меньшему.

## Меры по неповторению
Юнит-тесты, проверяющие фильтрацию и сортировку результатов `top_k`.

## Отчёт
После исправления сервис корректно выбирает ближайшие шаблоны и предупреждает о низком `score` только когда это действительно необходимо.
