# IdentityService registers invalid alias cases

## Проблема
IdentityService сохраняет alias задачи для частичных или пустых слотов, когда LLM возвращает некорректные значения. В базе появляются сущности вроде `"to go with her"` с типом `GOAL` или местоимения `"he"` как `CHARACTER`.

## Контекст
Пример сохранённых записей:
```
{ "alias_text": "to go with her", "entity_type": "GOAL" }
{ "alias_text": "he", "entity_type": "CHARACTER" }
```
Такие объекты создаются после вызова `/extract-save` и проходят в `commit_aliases`, хотя должны отфильтровываться.

## Причина
Промпт `extract_slots.j2` не ограничивает вывод модели: при отсутствии данных LLM заполняет слот случайным текстом. `IdentityService` не проверяет результат на `null` и принимает любую строку.

## Анализ промптов
- `extract_slots.j2` — добавить явное условие: если в тексте нет полного имени или цели, слот заполняется `null`. Местоимения вроде "he" или "she" не считаются допустимыми значениями.
- `fallback_slots.j2` — при заполнении обязательных полей не придумывать названия. Если текст не содержит нужного объекта, оставить `null`.
- `generate_slots.j2` — запретить генерацию имён и целей, которых нет в исходном фрагменте.
- `verify_alias_llm.j2` — предусмотреть ответ `"skip"` для случая, когда `raw_name` является местоимением или случайной фразой. Такой ответ не должен создавать сущность.
- `shared_instructions.j2` — усилить правило: не интерпретировать неопределённые отрезки текста как названия, всегда возвращать `null` при сомнениях.

## Последствия
Регистрируются ложные сущности и алиасы. База наполняется мусорными записями, что мешает дальнейшей работе сервисов и снижает точность поиска.

## Планируемые изменения
1. Дополнить `shared_instructions.j2` и `extract_slots.j2` блоком инструкций:

   ```
   Important rules:
   - Return exactly `null` for any slot when there is no clear **name**, **title**, **goal**, **character**, **faction**, etc. explicitly present in the snippet.
   - Do **not** invent or infer values.
   - Do **not** return pronouns (e.g. "he", "she", "they") or vague phrases ("to go with her") as valid entities.
   - Do **not** return the snippet verbatim.
   ```
2. Внести такое же уточнение в `fallback_slots.j2` и `generate_slots.j2`.
3. В `verify_alias_llm.j2` добавить действие `skip`; сервис должен игнорировать такие ответы.
4. `IdentityService` проверяет alias_text по списку стоп‑слов, минимальной длине и наличию пробелов. При несоответствии запись отбрасывается.
5. Логировать все отклонённые случаи для последующего анализа.

## Локация
- `app/services/identity/service.py` – проверка значений перед созданием `AliasTask`.
- `app/core/slots/prompts/jinja/extract_slots.j2` – обновлённый текст промпта.
- Полный список шаблонов см. в `docs/prompts_index.md`.

## Улучшения
Помимо основной проверки стоит:
- поддерживать список местоимений и общих фраз для всех языков,
- отсекать слишком короткие значения (например, < 3 символов),
- сравнивать alias_text с исходным `snippet` и отклонять, если совпадает целиком.

## Деплой
Пересобрать образы после изменения шаблонов и кода. Миграций не требуется.

## Проверка
- Unit-тесты для `IdentityService.commit_aliases`, подтверждающие, что пустые/стоп‑слотовые значения игнорируются.
- Ручной вызов `/extract-save` на проблемном тексте не должен создавать новые алиасы.

## Меры по неповторению
Тест на обработку `null` значений слота и на фильтрацию местоимений.

## Отчёт
После фикса сервис игнорирует неинформативные ответы LLM и база остаётся чистой.
