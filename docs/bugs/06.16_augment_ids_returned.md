# Bug Report: IDs returned instead of names in /augment-context

## Проблема
Эндпоинт `/augment-context` возвращает идентификаторы персонажей вместо их имён.
Это нарушает ожидания клиентов: результаты должны содержать исходные алиасы.

## Контекст
После исправления, описанного в `character_relation_augment_issue.md`,
пайплайн должен подменять ID на алиасы из `IdentityService.alias_map`.
В текущей версии замена происходит только для ID, переданных во входном
тексте, поэтому результаты могут включать необработанные ID из базы.

## Причина
`AugmentPipeline` использует локальный `alias_map` и не запрашивает алиасы
для ID, которые пришли из базы данных, если они не встретились в исходном
тексте. В ответе появляются значения вида `character-a255d71b`.

## Последствия
Клиенты не могут напрямую отображать имена персонажей и должны делать
дополнительные запросы.

## Планируемые изменения
1. Добавить метод в `IdentityService`, который по списку ID возвращает
   известные алиасы.
2. В `AugmentPipeline.augment_context` после получения результатов
   запросить недостающие алиасы и заменить их в строках ответа.
3. Обновить тесты.

## Локация
- `app/services/identity_service.py`
- `app/services/pipeline.py`
- тесты в `app/tests/unit/services/pipeline`

## Улучшения
Сделать `trace_id` опциональным полем и заполнять его только при наличии
трассировки. Тип `draft_stage` в ответах лучше приводить к строковому
значению.

## Деплой
Миграций не требуется.

## Проверка
- `pytest -q` должно проходить без ошибок.
- Ручной вызов `/augment-context` возвращает имена вместо ID.

## Меры по неповторению
Добавлен юнит‑тест, проверяющий подмену ID в `augment_context`.

## Отчёт
После фикса `/augment-context` возвращает алиасы для всех ID в строках
контекста, поле `meta_draft_stage` содержит название стадии.
