–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (`ChunkNode ‚Üí –¥–æ–º–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ ‚Üí RaptorNode`) –∏ —É–∂–µ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –º–æ–¥–µ–ª–µ–π, –Ω–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä **–∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –º–æ–¥–µ–ª—è—Ö** –∏ **–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞**:

---

## ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö (—Å–≤–æ–¥–∫–∞)

### 1. `SlotDefinition`

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.**\
–û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è LLM-—ç–∫—Å—Ç—Ä–∞–∫—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω—ã–µ –±—É–¥—É—â–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:

- `is_entity_ref: bool` ‚Äî —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ, —á—Ç–æ —Å–ª–æ—Ç —Ç—Ä–µ–±—É–µ—Ç identity-resolution.
- `enum_values: list[str]` ‚Äî –µ—Å–ª–∏ –Ω–∞–±–æ—Ä –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.

---

### 2. `FactDescriptor` ‚Üí `GraphRelationDescriptor`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
class GraphRelationDescriptor(BaseModel):
    predicate: str                  # MEMBER_OF, OWNS, etc.
    subject: str                    # "$character"
    object: Optional[str] = None    # "$faction"
    value: Optional[str] = None     # —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–†–æ–ª—å:**

- —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π;
- –∏—Å—Ç–æ—á–Ω–∏–∫ `subject`/`object` –¥–ª—è —Å–≤—è–∑–∏ —Å `ChunkNode`;
- –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑ —Å–ª–æ—Ç–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `triple_text` ‚Üí `fact_vec`.

---

### 3. `CypherTemplateBase`

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:**

```python
attachment_policy: Literal["chunk", "raptor", "both"] = "chunk"
default_confidence: float = 0.2
graph_relation: Optional[GraphRelationDescriptor]
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

- `attachment_policy` —É–ø—Ä–∞–≤–ª—è–µ—Ç, –≥–¥–µ —Å–ª–µ–¥—É–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É (`MENTIONS`, `REFERS_TO`).
- `default_confidence` —É–±–∏—Ä–∞–µ—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–∞–π–ø–ª–∞–π–Ω–∞.
- `graph_relation` –ø–æ–º–æ–≥–∞–µ—Ç —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π `fact_vec`.

---

### 4. `RenderedCypher`

**–í–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:**

```python
fact_cypher ‚Üí relation_cypher
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** —Ç–µ—Ä–º–∏–Ω–∞ `—Ñ–∞–∫—Ç` –∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –≥—Ä–∞—Ñ–µ –±–æ–ª—å—à–µ –Ω–µ—Ç.

---

## üîó –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥–µ–ª–∏ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∞

### üìå –ü–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∏—Ö —Ä–æ–ª–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä           | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è                                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                  |
| ------------------ | ------------------------------------------------- | ------------------------------------------------------------------------------------------- |
| `chunk_id`         | `chunk_mentions.j2`, Cypher —à–∞–±–ª–æ–Ω, aliases, embedding | –°–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–æ–¥—ã, —Å–≤—è–∑–∏, –∞–ª–∏–∞—Å—ã, raptor) —Å –æ–¥–Ω–∏–º —á–∞–Ω–∫-–±–ª–æ–∫–æ–º —Ç–µ–∫—Å—Ç–∞.            |
| `related_node_ids` | `chunk_mentions.j2`                                    | –°–ø–∏—Å–æ–∫ ID —Å—É—â–Ω–æ—Å—Ç–µ–π, —É—á–∞—Å—Ç–≤—É—é—â–∏—Ö –≤ –¥–æ–º–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö; –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–≤—è–∑–∞—Ç—å –∏—Ö —Å `ChunkNode`. |
| `template_id`      | Cypher ‚Üí `MERGE (... {template_id: ...})`         | –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–≤—è–∑–∏ ‚Äî –∏–∑ –∫–∞–∫–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –æ–Ω–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞.                             |
| `description`      | Cypher, UI                                        | –¢–µ–∫—Å—Ç–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞, –≤—Å—Ç–∞–≤–ª—è–µ–º–∞—è –≤ —Å–≤–æ–π—Å—Ç–≤–∞ —Ä—ë–±–µ—Ä –∏ —É–∑–ª–æ–≤.                        |
| `confidence`       | Cypher                                            | –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è weak facts –∏–∑ LLM).                                      |
| `draft_stage`      | Cypher, Chunk                                     | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ —Å—Ü–µ–Ω–æ–π.               |
| `triple_text`      | ‚Üí `fact_vec`                                      | –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∞ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º –≤–∏–¥–µ.                               |

---

### –®–∞–≥ 1: `CypherTemplateBase.render(slots, chunk_id)`

–ú–µ—Ç–æ–¥ `render()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ `slots`, –Ω–æ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ —à–∞–±–ª–æ–Ω `chunk_id` ‚Äî —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –º–æ–≥ –≤–∫–ª—é—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ `ChunkNode` –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π Cypher.

#### –ü—Ä–∏–º–µ—Ä:

```python
rendered = template.render(
    slots={"character": "UUID-1", "faction": "UUID-2"},
    chunk_id="chunk-xyz"
)
```

–í–Ω—É—Ç—Ä–∏ `render()`:

```python
context["chunk_id"] = chunk_id  # –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —è–≤–Ω–æ
```

–®–∞–±–ª–æ–Ω `chunk_mentions.j2` –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏:

```cypher
MATCH (chunk:Chunk {id: "{{ chunk_id }}"})
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, `chunk_id` ‚Äî **–≤–Ω–µ—à–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä**, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –∏–∑ Extraction-–ø–∞–π–ø–ª–∞–π–Ω–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —à–∞–±–ª–æ–Ω–∞.

#### –ò—Ç–æ–≥–æ, `chunk_id`:

- –∑–∞–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `/extract` –∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è `ChunkNode`;
- –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `template.render()` –∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Jinja-–∫–æ–Ω—Ç–µ–∫—Å—Ç;
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è `MATCH`, `MERGE`, `chunk_id`-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.

1. **–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω.**
2. **–§–æ—Ä–º–∏—Ä—É–µ—Ç**:
   - `content_cypher` ‚Äî –∫–æ–º–∞–Ω–¥—ã `MERGE` –¥–ª—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π (Character ‚Üí Faction).
   - `triple_text` ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–∫–∞ `"Aren MEMBER_OF Night Front"`.
3. **–ò–∑–≤–ª–µ–∫–∞–µ—Ç** `related_node_ids` –∏–∑ `GraphRelationDescriptor`.

---

### –®–∞–≥ 2: `chunk_mentions.j2` –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±–≤—è–∑–∫—É

```jinja2
WITH *
MATCH (chunk:Chunk {id: "{{ chunk_id }}"})
{% for node_id in related_node_ids %}
  MATCH (x{{ loop.index }} {id: "{{ node_id }}"})
{% endfor %}
{% for node_id in related_node_ids %}
  MERGE (chunk)-[:MENTIONS]->(x{{ loop.index }})
{% endfor %}
```

`MATCH`-—á–∞—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ `MERGE`. –ü–∞–π–ø–ª–∞–π–Ω —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ ``WITH *``
–∏ –∏—Å–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ –¥–≤—É–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏, –∏–∑–±–µ–≥–∞—è –æ—à–∏–±–∫–∏ Neo4j.

–≠—Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –∫ `ChunkNode`.

---

### –®–∞–≥ 3: SlotFiller ‚Üí triple\_text ‚Üí `fact_vec`

```python
triple_text = f"{subject} {predicate} {object}"
fact_vec = encoder.encode([triple_text])[0]
```

‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:

```python
centroid = Œ± * text_vec + Œ≤ * fact_vec
```

–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `RaptorNode`.

---

### –®–∞–≥ 4: GraphProxy

- –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–π `content_cypher` (–∏, –æ–ø—Ü., `alias_cypher`).
- –§–∏–∫—Å–∏—Ä—É–µ—Ç `:Chunk`, `:Character`, `:Faction`, `:Location` –∏ —Ç.–¥., –∞ —Ç–∞–∫–∂–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –Ω–∏–º–∏.
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å.

---

### –®–∞–≥ 5: –°–≤—è–∑—å —Å `RaptorNode`

- –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –≤—Å–µ —Å–≤—è–∑–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç `chunk_id`.
- `ChunkNode` —Å–æ–¥–µ—Ä–∂–∏—Ç `raptor_node_id`.
- –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å: –¥–æ–º–µ–Ω–Ω–∞—è —Å–≤—è–∑—å ‚Üê `Chunk` ‚Üê `RaptorNode`.

---

## üß† –í—ã–≤–æ–¥

1. `GraphRelationDescriptor` ‚Äî –∫–ª—é—á–µ–≤–æ–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Å–ª–æ–π: —Å–≤—è–∑—ã–≤–∞–µ—Ç —à–∞–±–ª–æ–Ω, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ç—Ä–æ–π–∫—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä.
2. `CypherTemplateBase` –æ—Å—Ç–∞—ë—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Cypher, –≤ —Ç–æ–º —á–∏—Å–ª–µ ‚Äî –≤ —Å–≤—è–∑–∫–µ —Å `ChunkNode` –∏ `RaptorNode`.
3. `RaptorNode` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fact_vec` –Ω–∞—Ä–∞–≤–Ω–µ —Å `text_vec`, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Å–º—ã—Å–ª–æ–≤—É—é –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é.
4. –°–≤—è–∑—å –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–¥—ë—Ç —á–µ—Ä–µ–∑ `chunk_id`, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

- —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON-—Å—Ö–µ–º—É –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π;
- –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —à–∞–±–ª–æ–Ω–æ–≤;
- –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –º–æ–¥–µ–ª–µ–π –∏ Cypher.
