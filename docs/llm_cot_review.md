# Анализ использования Chain-of-Thought

Документ фиксирует проблемы с сохранением рассуждений LLM и описывает шаги по их исправлению.

## Выявленные проблемы

- Слоты в `SlotFiller` собирают поле `details`, однако при создании `SlotFill` в `ExtractionPipeline` оно перезаписывается пустой строкой. Рассуждения модели теряются ещё до рендера Cypher.
- Шаблон `verify_alias_llm.j2` возвращает только действие без объяснений, поэтому CoT отсутствует.
- В `base_fact.j2` не выводятся поля из `GraphRelationDescriptor` и отсутствует место для `details`, поэтому связям и узлам негде хранить мотивацию решения.

## Обзор промптов

### `app/core/slots/prompts/jinja/extract_slots.j2`
Призывает модель объяснить заполнение каждого объекта в поле `"details"`. Это единственное место, где явно используется CoT, однако дальнейшие шаги его стирают.

### `app/core/slots/prompts/jinja/fallback_slots.j2`
Дополняет недостающие обязательные слоты и расширяет `"details"`. CoT присутствует, но не сохраняется.

### `app/core/slots/prompts/jinja/generate_slots.j2`
Генерирует значения необязательных полей и добавляет комментарий в `"details"`. Аналогично, объяснение не сохраняется в графе.

### `app/core/identity/prompts/jinja/verify_alias_llm.j2`
Используется для разрешения алиасов. Шаблон теперь просит модель объяснить выбор в поле
`"details"`, поэтому CoT присутствует и сохраняется вместе с решением.

### `app/core/identity/prompts/jinja/add_alias.j2`
Создаёт задачу на добавление алиаса. Шаблон не обращается к LLM, поэтому аспект CoT не актуален.

### `app/core/identity/prompts/jinja/create_entity_with_alias.j2`
Шаблон для создания сущности вместе с каноническим алиасом. Тоже не связан с LLM.

## План по исправлению

1. **Сохранение `details` в SlotFiller.**
   - Не обнулять `SlotFill.details` в `ExtractionPipeline._process_template`.
   - Добавить это поле в `RenderedCypher` и пробросить через `TemplateRenderer`.
2. **Дополнение `GraphRelationDescriptor`.**
   - Расширить модель, включив `details: Optional[str]`.
   - При рендере передавать `SlotFill.details` в `GraphRelationDescriptor`.
3. **Шаблон `base_fact.j2`.**
   - Включить вывод `triple_text`, `related_node_ids` и `details` в создаваемые свойства узлов/связей.
4. **Модификация `verify_alias_llm.j2`.**
   - Добавить инструкцию описывать логику выбора в отдельном поле `details`.
5. **Запись рассуждений в граф.**
   - При выполнении Cypher через `GraphProxy` сохранять `details` как свойство связи.
   - Это позволит анализировать причины решений и формировать богатый контекст для следующих шагов пайплайна.

Реализация данных пунктов сделает пайплайн совместимым с CoT и позволит использовать объяснения LLM в аналитике и обучении.
