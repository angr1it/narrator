# AGENTS.md

Файл задаёт основные правила работы с репозиторием. Вложенные AGENTS.md могут переопределять эти инструкции.

## Структура проекта
- `app/api` — роуты FastAPI
- `app/services` — бизнес-логика и пайплайны
- `app/schemas` — Pydantic-модели
- `app/config` — настройки и клиенты внешних сервисов
- `app/core` — авторизация и общие компоненты
- `app/utils` — Jinja-шаблоны, логгер, хелперы
- `app/templates` — базовые Jinja2-шаблоны
- `.env` — файл с переменными окружения (OpenAI, Weaviate, Neo4j и др.)
- `docker-compose.yaml` — локальное поднятие сервисов (Weaviate, API)
- `app/tests` — unit и интеграционные тесты
- `docs/` — документация
- `main.py` — точка входа

## Код-стайл
- PEP8 и обязательные аннотации типов
- Форматирование — `black`
- Линтер — `flake8`
- Используйте f-строки
- В Pydantic `Field()` заполняйте `description`
- Для логирования подключайте `get_logger` из `app.utils.logger`

## Локальная разработка

- Создать файл `.env` в корне проекта на основе примера (см. README.md).
- Поднять локальные сервисы через Docker Compose:
  ```bash
  docker-compose up -d weaviate
  ```
- Проверить доступность Weaviate:
  ```bash
  curl http://localhost:8080/v1/meta
  ```
- Интеграционные тесты помечены маркером `integration` и по умолчанию пропускаются.
- Для запуска интеграционных тестов используйте флаг `--runintegration`:
  ```bash
  pytest --runintegration -q
  ```

## Тестирование

- Запуск всех тестов: `pytest -q`
- Общие фикстуры (включая `event_loop`) находятся в `app/tests/conftest.py`

### Структура

Тесты строго зеркально повторяют структуру `app/`, чтобы можно было однозначно определить, где лежат тесты для каждого компонента:

```
app/services/pipeline.py
→ app/tests/unit/services/pipeline/test_pipeline_.py
→ app/tests/integration/services/pipeline/test_pipeline_.py
```

### Юнит-тесты

- Располагаются в `app/tests/unit/...`
- Изолированы от внешних сервисов: БД, LLM, эмбеддинги
- Используют мок-объекты и фикстуры из `conftest.py`
- Не обращаются к переменным окружения или сетевым ресурсам

### Интеграционные тесты

- Располагаются в `app/tests/integration/...`
- Предполагается, что перед запуском заданы все переменные окружения и запущены внешние сервисы
  (OpenAI, Weaviate и др.). Не добавляйте в код принудительные `skip` из-за их отсутствия.
- Если интеграционные тесты вызывают ошибки окружения, опишите это в ответе, не меняя код тестов.
- По умолчанию запускается только `pytest -q`; интеграционные тесты помечены маркером `integration` и
- выполняются при добавлении флага `--runintegration`.

### Практика TDD

При добавлении нового класса или функции сразу создавайте минимальные юнит-тесты в соответствующей зеркальной директории. Структура кода и тестов должна оставаться синхронизированной.

### Best Practices для pytest (юнит-тесты)

- Используйте для переиспользуемой подготовки данных и окружения. Общие — в conftest.py.
- Тесты независимы, без сохранения состояния.
- Названия описывают поведение: test_get_user_returns_404.
- Без дублирования:Общую логику — в фикстуры или хелперы.
- Используйте @pytest.mark.parametrize для разных входов.
- Один тест — одна проверка. Лучше больше, но простых.

## Pull request
- Заголовок — короткий глагол в повелительной форме
- Описание включает разделы `## Summary` и `## Testing`

## Обязательные проверки перед слиянием
- `black --check .`
- `flake8`
- `mypy .`
- `pytest -q`

### Pre-commit
- После установки зависимостей выполните `pre-commit install`
- Хуки запускают все обязательные проверки
- Чтобы проверить типы только в изменённых файлах, выполните
  `pre-commit run mypy --from-ref origin/master --to-ref HEAD`
